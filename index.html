<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lista de Presentes - Ch√° de Beb√™</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      background: #ffe2e2;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 15px;
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .container {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 800px;
    }
    h2 {
      text-align: center;
      margin-bottom: 25px;
      color: #ff6b6b;
      font-size: clamp(22px, 5vw, 28px);
      padding: 0 10px;
    }
    .item {
      background: #f9f9f9;
      padding: 15px;
      margin-bottom: 12px;
      border-radius: 10px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      border-left: 5px solid #ff9a9a;
      transition: all 0.3s ease;
    }
    @media (min-width: 480px) {
      .item {
        flex-direction: row;
        justify-content: space-between;
        align-items: center;
        gap: 0;
      }
    }
    .item:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.1);
    }
    .item.reservado {
      background: #f0f0f0;
      border-left-color: #cccccc;
    }
    .item-text {
      flex-grow: 1;
      font-weight: 500;
      font-size: clamp(16px, 4vw, 18px);
    }
    .item-escolhido {
      color: #888;
      text-decoration: line-through;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: #ff9a9a;
      color: white;
      font-weight: bold;
      transition: all 0.3s;
      min-width: 110px;
      font-size: clamp(14px, 4vw, 16px);
      width: 100%;
    }
    @media (min-width: 480px) {
      button {
        width: auto;
      }
    }
    button:hover {
      background: #ff7b7b;
      transform: scale(1.05);
    }
    button:disabled {
      background: #cccccc;
      color: #888;
      cursor: not-allowed;
      transform: none;
    }
    .status {
      text-align: center;
      margin: 20px 0;
      font-weight: bold;
      color: #ff6b6b;
      background: white;
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    }
    .progress-bar {
      height: 12px;
      background: #e0e0e0;
      border-radius: 6px;
      margin: 15px 0;
      overflow: hidden;
    }
    .progress {
      height: 100%;
      background: linear-gradient(90deg, #ff9a9a, #ff6b6b);
      transition: width 0.5s ease;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      justify-content: center;
      align-items: center;
      z-index: 1000;
      padding: 15px;
    }
    .modal-content {
      background: white;
      padding: clamp(20px, 5vw, 35px);
      border-radius: 15px;
      text-align: center;
      max-width: 450px;
      width: 100%;
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
      animation: modalAppear 0.3s ease-out;
    }
    @keyframes modalAppear {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    .modal h3 {
      color: #ff6b6b;
      margin-top: 0;
      font-size: clamp(20px, 5vw, 24px);
      margin-bottom: 15px;
    }
    .modal p {
      margin: 15px 0;
      font-size: clamp(15px, 4vw, 16px);
    }
    .modal-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 20px;
    }
    @media (min-width: 480px) {
      .modal-buttons {
        flex-direction: row;
        justify-content: center;
      }
    }
    .modal button {
      margin: 0;
      flex: 1;
    }
    .nome-input {
      padding: 12px;
      border: 2px solid #ff9a9a;
      border-radius: 8px;
      width: 100%;
      margin: 15px 0;
      font-size: 16px;
      text-align: center;
    }
    .nome-input:focus {
      outline: none;
      border-color: #ff6b6b;
      box-shadow: 0 0 0 3px rgba(255, 107, 107, 0.2);
    }
    .btn-confirmar {
      background: #4CAF50;
    }
    .btn-confirmar:hover {
      background: #45a049;
    }
    .btn-cancelar {
      background: #f44336;
    }
    .btn-cancelar:hover {
      background: #da190b;
    }
    .completo {
      animation: pulse 2s infinite;
      background: linear-gradient(90deg, #4CAF50, #45a049);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
      font-size: clamp(16px, 4vw, 18px);
    }
    .loading {
      text-align: center;
      color: #ff6b6b;
      font-style: italic;
      padding: 20px;
      font-size: clamp(16px, 4vw, 18px);
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    .footer {
      margin-top: 30px;
      text-align: center;
      color: #ff6b6b;
      font-size: 14px;
      padding: 15px;
    }
    .footer a {
      color: #ff6b6b;
      text-decoration: none;
      font-weight: bold;
    }
    .footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üéÄ Lista de Presentes - Ch√° de Beb√™ üéÄ</h2>
    
    <div class="status">
      <div id="progress-text">Carregando...</div>
      <div class="progress-bar">
        <div id="progress" class="progress" style="width: 0%"></div>
      </div>
      <div id="status-message"></div>
    </div>

    <div id="lista">
      <div class="loading">Carregando lista de presentes...</div>
    </div>
  </div>

  <div id="modal-confirmacao" class="modal">
    <div class="modal-content">
      <h3>üéâ Presente Reservado!</h3>
      <p id="mensagem-confirmacao"></p>
      <div class="modal-buttons">
        <button onclick="fecharModal()">Fechar</button>
      </div>
    </div>
  </div>

  <div id="modal-nome" class="modal">
    <div class="modal-content">
      <h3>Digite seu nome</h3>
      <p>Por favor, digite seu nome completo para reservar este presente:</p>
      <input type="text" id="input-nome" class="nome-input" placeholder="Seu nome completo">
      <div class="modal-buttons">
        <button class="btn-confirmar" onclick="confirmarReserva()">Confirmar</button>
        <button class="btn-cancelar" onclick="cancelarReserva()">Cancelar</button>
      </div>
    </div>
  </div>

  <div class="footer">
    Desenvolvido com ‚ù§Ô∏è por <a href="https://instagram.com/torreswebsec" target="_blank">@torreswebsec</a>
  </div>

  <script>
    /*******************************
     * üóÉÔ∏è CONFIGURA√á√ÉO DO BANCO DE DADOS JSON
     *******************************/
    
    // üîë SUA CHAVE DO JSONBIN
    const JSONBIN_API_KEY = '$2a$10$gwK.fRdy/XOY58pUaOrVy.pDA8YA4PizNjsEoK4rD7OWhVRlWiCS6';
    const JSONBIN_BIN_ID = '691f32a7d0ea881f40f4bdae';
    
    // URL do seu banco de dados JSON
    const DB_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}/latest`;
    const DB_UPDATE_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;

    // Estrutura inicial do banco de dados
    const estruturaInicial = {
      itens: [
        { id: 1,  item: "Kit de cortador de unha", reservadoPor: null, data: null },
        { id: 2,  item: "Kit de pente e escova de cabelo", reservadoPor: null, data: null },
        { id: 3,  item: "Toalha", reservadoPor: null, data: null },
        { id: 4,  item: "Toalha", reservadoPor: null, data: null },
        { id: 5,  item: "Toalha", reservadoPor: null, data: null },
        { id: 6,  item: "Banheira", reservadoPor: null, data: null },
        { id: 7,  item: "Kit de mamadeira Mam", reservadoPor: null, data: null },
        { id: 8,  item: "Trocador Ikea (almofada)", reservadoPor: null, data: null },
        { id: 9,  item: "Kit de len√ßol do trocador", reservadoPor: null, data: null },
        { id: 10, item: "Chupeta Mam 1‚Äì3 meses + len√ßo umedecido", reservadoPor: null, data: null },
        { id: 11, item: "Chupeta Mam 3‚Äì6 meses + len√ßo umedecido", reservadoPor: null, data: null },
        { id: 12, item: "Porta chupeta + len√ßo umedecido", reservadoPor: null, data: null },
        { id: 13, item: "Porta chupeta", reservadoPor: null, data: null },
        { id: 14, item: "Manta quentinha", reservadoPor: null, data: null },
        { id: 15, item: "Pacote de cueiro", reservadoPor: null, data: null },
        { id: 16, item: "Mordedor + len√ßo umedecido", reservadoPor: null, data: null },
        { id: 17, item: "Mordedor + len√ßo umedecido", reservadoPor: null, data: null },
        { id: 18, item: "Luvinha + meinha", reservadoPor: null, data: null },
        { id: 19, item: "Luvinha + meinha", reservadoPor: null, data: null }
      ],
      ultimaAtualizacao: new Date().toISOString()
    };

    let bancoDeDados = { ...estruturaInicial };
    let itemIdParaReservar = null;

    /************************************
     * üîÑ FUN√á√ïES DO BANCO DE DADOS
     ************************************/

    // üîç BUSCAR DADOS DO BANCO
    async function carregarDoBanco() {
      try {
        console.log('üì• Carregando dados do banco...');
        
        const response = await fetch(DB_URL, {
          method: 'GET',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error('Erro ao carregar dados');
        }

        const data = await response.json();
        console.log('‚úÖ Dados carregados:', data);
        
        if (data.record && data.record.itens) {
          bancoDeDados = data.record;
          return true;
        } else {
          // Se n√£o existir dados, criar estrutura inicial
          await salvarNoBanco();
          return true;
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar do banco:', error);
        // Usar dados locais em caso de erro
        bancoDeDados = { ...estruturaInicial };
        return false;
      }
    }

    // üíæ SALVAR DADOS NO BANCO
    async function salvarNoBanco() {
      try {
        console.log('üíæ Salvando dados no banco...');
        
        bancoDeDados.ultimaAtualizacao = new Date().toISOString();
        
        const response = await fetch(DB_UPDATE_URL, {
          method: 'PUT',
          headers: {
            'X-Master-Key': JSONBIN_API_KEY,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(bancoDeDados)
        });

        if (!response.ok) {
          throw new Error('Erro ao salvar dados');
        }

        const data = await response.json();
        console.log('‚úÖ Dados salvos com sucesso!');
        return true;
      } catch (error) {
        console.error('‚ùå Erro ao salvar no banco:', error);
        alert('Erro ao salvar reserva. Tente novamente.');
        return false;
      }
    }

    /**************
     * üñ•Ô∏è RENDERIZAR LISTA
     **************/
    function render() {
      const div = document.getElementById("lista");
      
      const itensEscolhidos = bancoDeDados.itens.filter(i => i.reservadoPor).length;
      const totalItens = bancoDeDados.itens.length;
      const percentual = (itensEscolhidos / totalItens) * 100;
      
      document.getElementById("progress-text").textContent = `Escolhidos: ${itensEscolhidos}/${totalItens}`;
      document.getElementById("progress").style.width = `${percentual}%`;
      
      const statusMessage = document.getElementById("status-message");
      if (itensEscolhidos === totalItens) {
        statusMessage.innerHTML = '<div class="completo">üéâ Todos os presentes foram escolhidos! Obrigada a todos! üéâ</div>';
        enviarNotificacaoCompleta();
      } else {
        statusMessage.innerHTML = '';
      }

      let html = '';
      bancoDeDados.itens.forEach(i => {
        const isReservado = i.reservadoPor;
        html += `
          <div class="item ${isReservado ? 'reservado' : ''}">
            <div class="item-text ${isReservado ? 'item-escolhido' : ''}">
              ${i.item} ${isReservado ? '‚úÖ' : ''}
            </div>
            <button ${isReservado ? "disabled" : ""} onclick="reservar(${i.id})">
              ${isReservado ? "Escolhido" : "Escolher"}
            </button>
          </div>
        `;
      });
      
      div.innerHTML = html;
    }

    /*************************
     * üõí RESERVAR PRESENTE
     *************************/
    function reservar(id) {
      itemIdParaReservar = id;
      
      const modal = document.getElementById("modal-nome");
      const input = document.getElementById("input-nome");
      input.value = "";
      modal.style.display = "flex";
      // Foco no input ap√≥s um pequeno delay para garantir que o modal est√° vis√≠vel
      setTimeout(() => input.focus(), 100);
    }

    async function confirmarReserva() {
      const nome = document.getElementById("input-nome").value.trim();
      
      if (!nome) {
        alert("Por favor, digite seu nome!");
        return;
      }

      const nomeLower = nome.toLowerCase();

      // Verificar se o nome j√° escolheu algum item
      const jaEscolheu = bancoDeDados.itens.some(item => 
        item.reservadoPor && item.reservadoPor.toLowerCase() === nomeLower
      );
      
      if (jaEscolheu) {
        alert(`‚ùå Desculpe, ${nome}, voc√™ j√° escolheu um presente!\n\nCada pessoa pode escolher apenas um item.`);
        fecharModalNome();
        return;
      }

      const item = bancoDeDados.itens.find(x => x.id === itemIdParaReservar);
      if (!item) {
        alert("Item n√£o encontrado!");
        fecharModalNome();
        return;
      }
      
      if (item.reservadoPor) {
        alert("‚ùå Este item j√° foi escolhido por outra pessoa!");
        fecharModalNome();
        return;
      }

      const agora = new Date().toLocaleString("pt-BR");

      // Fazer a reserva
      item.reservadoPor = nome;
      item.data = agora;

      // Salvar no banco de dados
      const salvou = await salvarNoBanco();
      
      if (salvou) {
        // Atualizar a interface
        render();
        // Mostrar confirma√ß√£o
        mostrarConfirmacao(nome, item.item);
      }
      
      fecharModalNome();
    }

    function cancelarReserva() {
      fecharModalNome();
    }

    function fecharModalNome() {
      const modal = document.getElementById("modal-nome");
      modal.style.display = "none";
      itemIdParaReservar = null;
    }

    /*************************
     * üéâ MODAL DE CONFIRMA√á√ÉO
     *************************/
    function mostrarConfirmacao(nome, item) {
      const modal = document.getElementById("modal-confirmacao");
      const mensagem = document.getElementById("mensagem-confirmacao");
      
      mensagem.innerHTML = `
        <strong>Parab√©ns, ${nome}!</strong><br><br>
        Voc√™ escolheu: <strong>"${item}"</strong>.<br><br>
        Obrigada por fazer parte deste momento especial! üíñ<br><br>
        <small>Anote o presente que escolheu para n√£o esquecer!</small>
      `;
      modal.style.display = "flex";
    }

    function fecharModal() {
      const modal = document.getElementById("modal-confirmacao");
      modal.style.display = "none";
    }

    /*************************
     * üì± NOTIFICA√á√ÉO COMPLETA
     *************************/
    function enviarNotificacaoCompleta() {
      let mensagem = "üéâ *LISTA DE PRESENTES COMPLETA!* üéâ\n\n";
      mensagem += "Todos os presentes foram escolhidos:\n\n";
      
      bancoDeDados.itens.forEach(item => {
        mensagem += `‚Ä¢ ${item.item} - ${item.reservadoPor}\n`;
      });
      
      console.log("=== LISTA COMPLETA ===");
      console.log(mensagem);
      
      alert("üéâ LISTA COMPLETA! üéâ\n\n" + mensagem);
    }

    // Event listeners
    window.onclick = function(event) {
      const modalConfirmacao = document.getElementById("modal-confirmacao");
      const modalNome = document.getElementById("modal-nome");
      
      if (event.target === modalConfirmacao) fecharModal();
      if (event.target === modalNome) fecharModalNome();
    }

    document.getElementById("input-nome").addEventListener("keypress", function(event) {
      if (event.key === "Enter") confirmarReserva();
    });

    /***************************************
     * üöÄ INICIALIZA√á√ÉO
     ***************************************/
    async function inicializar() {
      console.log("üöÄ Iniciando aplica√ß√£o...");
      
      // Carregar dados do banco
      const sucesso = await carregarDoBanco();
      
      if (sucesso) {
        render();
        console.log("‚úÖ Aplica√ß√£o carregada com sucesso!");
      } else {
        document.getElementById("lista").innerHTML = 
          '<div class="loading">‚ùå Erro ao carregar dados. Recarregue a p√°gina.</div>';
      }
    }

    // Iniciar quando a p√°gina carregar
    document.addEventListener('DOMContentLoaded', inicializar);

    // Atualizar a cada 30 segundos para pegar mudan√ßas de outros usu√°rios
    setInterval(async () => {
      await carregarDoBanco();
      render();
    }, 30000);

  </script>
</body>
</html>
